{% extends "base_material.html" %}

{% block title %}Dashboard - MongoDB Ops Manager{% endblock %}
{% block page_title %}MongoDB Ops Manager Dashboard{% endblock %}
{% block page_subtitle %}Monitor and manage MongoDB clusters across all environments{% endblock %}

{% block page_actions %}
{% if selected_ops_manager %}
<button type="submit" form="opsManagerForm" name="refresh" value="1" class="btn btn-primary" data-loading="true">
  <i class="ti ti-refresh me-1"></i>
  Refresh Data
</button>
{% endif %}
{% endblock %}

{% block content %}
<!-- Status Messages -->
{% if status_message %}
<div class="row">
  <div class="col-12">
    <div class="alert alert-{% if status_type == 'error' %}danger{% elif status_type == 'warning' %}warning{% elif status_type == 'info' %}info{% else %}success{% endif %} alert-dismissible fade show" role="alert">
      <div class="d-flex align-items-center">
        <div class="me-2">
          {% if status_type == 'success' %}
            <i class="ti ti-check-circle"></i>
          {% elif status_type == 'warning' %}
            <i class="ti ti-alert-triangle"></i>
          {% elif status_type == 'error' %}
            <i class="ti ti-x-circle"></i>
          {% else %}
            <i class="ti ti-info-circle"></i>
          {% endif %}
        </div>
        <div>{{ status_message }}</div>
      </div>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  </div>
</div>
{% endif %}

<!-- Quick Stats Cards -->
<div class="row mb-4">
  <div class="col-sm-6 col-lg-3">
    <div class="card card-sm">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-auto">
            <span class="bg-primary text-white avatar">
              <i class="ti ti-server"></i>
            </span>
          </div>
          <div class="col">
            <div class="font-weight-medium">
              Total Ops Managers
            </div>
            <div class="text-muted">
              {{ options|length }} configured
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="card card-sm">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-auto">
            <span class="bg-success text-white avatar">
              <i class="ti ti-database"></i>
            </span>
          </div>
          <div class="col">
            <div class="font-weight-medium">
              Active Clusters
            </div>
            <div class="text-muted">
              {% if data %}{{ data|length }}{% else %}0{% endif %} clusters
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="card card-sm">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-auto">
            <span class="bg-warning text-white avatar">
              <i class="ti ti-users"></i>
            </span>
          </div>
          <div class="col">
            <div class="font-weight-medium">
              Unique Users
            </div>
            <div class="text-muted">
              {{ unique_usernames|length }} users
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="card card-sm">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-auto">
            <span class="bg-info text-white avatar">
              <i class="ti ti-clock"></i>
            </span>
          </div>
          <div class="col">
            <div class="font-weight-medium">
              Cache Status
            </div>
            <div class="text-muted">
              {% if cache_timestamp %}<span id="cache-timestamp" data-utc="{{ cache_timestamp }}">{{ cache_timestamp[:10] }}</span>{% else %}No cache{% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="row">
  <!-- Data Table -->
  <div class="col-lg-9">
    <div class="card">
      <div class="card-header d-flex align-items-center justify-content-between">
        <h3 class="card-title">
          <i class="ti ti-list me-2"></i>
          Cluster Overview
        </h3>
        <div class="card-actions d-flex align-items-center">
          {% if data and data|length > 0 %}
          <button type="button" class="btn btn-success btn-sm me-2" onclick="exportToCSV('overview')" title="Export to CSV">
            <i class="ti ti-download"></i>
            Export CSV
          </button>
          {% endif %}
          <span class="badge bg-{% if data and data|length > 0 %}primary{% else %}secondary{% endif %} fs-6">
            {% if data %}{{ data|length }}{% else %}0{% endif %} clusters
          </span>
        </div>
      </div>
      
      {% if data and data|length > 0 %}
      <div class="card-body p-0">
        <!-- Table Controls -->
        <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
          <div class="d-flex align-items-center">
            <label for="rowsPerPage" class="form-label me-2 mb-0">Show:</label>
            <select id="rowsPerPage" class="form-select form-select-sm w-auto" onchange="updatePagination()">
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100" selected>100</option>
              <option value="All">All</option>
            </select>
            <span class="text-muted ms-2">entries</span>
          </div>
          <div>
            <nav aria-label="Table navigation">
              <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
            </nav>
          </div>
        </div>
        
        <!-- Enhanced Table -->
        <div class="table-responsive">
          <table class="table table-hover mb-0" id="clusters-table">
            <thead>
              <tr>
                <th><i class="ti ti-building me-1"></i>Project</th>
                <th><i class="ti ti-server me-1"></i>Ops Manager</th>
                <th><i class="ti ti-copy me-1"></i>Replica Set</th>
                <th><i class="ti ti-world me-1"></i>Hostname:Port</th>
                <th><i class="ti ti-user me-1"></i>Username</th>
                <th><i class="ti ti-clock me-1"></i>Last Ping</th>
                <th><i class="ti ti-shield me-1"></i>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for item in data %}
              <tr>
                <td>
                  <div class="d-flex align-items-center">
                    {% set last_ping = item.get('Last Ping', '') or '' %}
                    <span class="status-indicator {% if last_ping.endswith('seconds') or last_ping.endswith('minute') %}status-online{% elif 'hour' in last_ping %}status-warning{% else %}status-offline{% endif %}"></span>
                    <strong>{{ item.get('Project', 'N/A') }}</strong>
                  </div>
                </td>
                <td>
                  <span class="text-muted">{{ item.get('Ops Manager', 'N/A') }}</span>
                </td>
                <td>
                  <code class="text-primary">{{ item.get('Replica Set Name', 'N/A') }}</code>
                </td>
                <td>
                  <span class="font-monospace text-info">{{ item.get('Hostname:Port', 'N/A') }}</span>
                </td>
                <td>
                  {% if item.get('Username') and item.get('Username') != 'null' %}
                    <span class="badge bg-green-lt">{{ item.get('Username') }}</span>
                  {% else %}
                    <span class="badge bg-red-lt">No Username</span>
                  {% endif %}
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    {% set last_ping = item.get('Last Ping', '') or '' %}
                    <span class="status-indicator {% if last_ping.endswith('seconds') or last_ping.endswith('minute') %}status-online{% elif 'hour' in last_ping %}status-warning{% else %}status-offline{% endif %}"></span>
                    <span class="{% if last_ping.endswith('seconds') or last_ping.endswith('minute') %}text-success{% elif 'hour' in last_ping %}text-warning{% else %}text-danger{% endif %}">
                      {{ last_ping or 'Unknown' }}
                    </span>
                  </div>
                </td>
                <td>
                  <span class="badge bg-success-lt">Active</span>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% else %}
      <div class="card-body text-center py-5">
        <div class="empty-state">
          <div class="empty-state-icon bg-primary-lt">
            <i class="ti ti-database-off"></i>
          </div>
          <h3 class="empty-state-title">No cluster data available</h3>
          <p class="empty-state-subtitle">Select an Ops Manager from the sidebar to view cluster information.</p>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
  
  <!-- Sidebar -->
  <div class="col-lg-3">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="ti ti-server-2 me-2"></i>
          Ops Manager
        </h3>
      </div>
      <div class="card-body">
        <form method="POST" action="/" id="opsManagerForm">
          <div class="mb-3">
            <label class="form-label">Select Ops Manager</label>
            <select class="form-select" name="ops_manager" onchange="this.form.submit()">
              <option value="">Choose an Ops Manager...</option>
              {% for option in options %}
              <option value="{{ option.name }}" {% if selected_ops_manager == option.name %}selected{% endif %}>
                {{ option.name }}
              </option>
              {% endfor %}
            </select>
          </div>
        </form>
        
        {% if selected_ops_manager %}
        <div class="mt-3">
          <div class="card bg-primary-lt">
            <div class="card-body p-3">
              <div class="d-flex align-items-center">
                <div class="me-3">
                  <i class="ti ti-server-2 fs-2 text-primary"></i>
                </div>
                <div>
                  <h4 class="mb-1">{{ selected_ops_manager }}</h4>
                  <p class="text-muted mb-0 small">Selected Ops Manager</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
    
    <!-- Username Filters -->
    {% if unique_usernames %}
    <div class="card mt-4">
      <div class="card-header">
        <h3 class="card-title">
          <i class="ti ti-filter me-2"></i>
          Username Filters
        </h3>
      </div>
      <div class="card-body">
        {% for username in unique_usernames %}
        <div class="form-check mb-2">
          <input class="form-check-input username-filter" type="checkbox" 
                id="usernameFilter{{ loop.index }}" 
                value="{{ username }}"
                onchange="filterTable()">
          <label class="form-check-label" for="usernameFilter{{ loop.index }}">
            {% if username == 'NONE' %}
              <span class="badge bg-red-lt">No Username</span>
            {% else %}
              <span class="badge bg-green-lt">{{ username }}</span>
            {% endif %}
          </label>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Enhanced pagination and table functionality
let currentPage = 1;
let rowsPerPage = 100;
let tableRows = [];

function initPagination() {
  const table = document.querySelector('#clusters-table');
  if (table) {
    tableRows = Array.from(table.querySelectorAll('tbody tr'));
    updatePagination();
  }
}

function updatePagination() {
  const rowsPerPageElement = document.getElementById('rowsPerPage');
  if (rowsPerPageElement) {
    rowsPerPage = rowsPerPageElement.value;
    if (rowsPerPage === 'All') {
      rowsPerPage = tableRows.length;
    } else {
      rowsPerPage = parseInt(rowsPerPage);
    }
  }
  currentPage = 1;
  showPage(currentPage);
  createPaginationControls();
}

function showPage(page) {
  const start = (page - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  tableRows.forEach((row, index) => {
    row.style.display = (index >= start && index < end) ? '' : 'none';
  });
}

function createPaginationControls() {
  const totalPages = Math.ceil(tableRows.length / rowsPerPage);
  const paginationUl = document.getElementById('pagination');
  paginationUl.innerHTML = '';

  if (totalPages <= 1) return;

  // Previous button
  const prevLi = document.createElement('li');
  prevLi.className = 'page-item' + (currentPage === 1 ? ' disabled' : '');
  prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">Previous</a>`;
  paginationUl.appendChild(prevLi);

  // Page numbers (show max 5 pages)
  let startPage = Math.max(1, currentPage - 2);
  let endPage = Math.min(totalPages, startPage + 4);
  
  if (endPage - startPage < 4) {
    startPage = Math.max(1, endPage - 4);
  }

  for (let i = startPage; i <= endPage; i++) {
    const li = document.createElement('li');
    li.className = 'page-item' + (i === currentPage ? ' active' : '');
    li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>`;
    paginationUl.appendChild(li);
  }

  // Next button
  const nextLi = document.createElement('li');
  nextLi.className = 'page-item' + (currentPage === totalPages ? ' disabled' : '');
  nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">Next</a>`;
  paginationUl.appendChild(nextLi);
}

function changePage(page) {
  const totalPages = Math.ceil(tableRows.length / rowsPerPage);
  if (page < 1 || page > totalPages) return;
  currentPage = page;
  showPage(currentPage);
  createPaginationControls();
}

// Export to CSV functionality
function exportToCSV(dataType) {
  const table = document.querySelector('#clusters-table');
  if (!table) {
    alert('No table data available to export.');
    return;
  }
  
  const rows = table.querySelectorAll('tbody tr');
  const visibleRows = Array.from(rows).filter(row => row.style.display !== 'none');
  
  if (visibleRows.length === 0) {
    alert('No visible data to export.');
    return;
  }
  
  // Get headers
  const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
  
  // Create CSV content
  let csvContent = '';
  csvContent += headers.map(header => `"${header.replace(/"/g, '""')}"`).join(',') + '\n';
  
  // Add data rows
  visibleRows.forEach(row => {
    const cells = Array.from(row.querySelectorAll('td')).map(td => {
      let text = td.textContent.trim();
      return `"${text.replace(/"/g, '""')}"`;
    });
    csvContent += cells.join(',') + '\n';
  });
  
  // Create download
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  
  const now = new Date();
  const timestamp = now.getFullYear() + 
    String(now.getMonth() + 1).padStart(2, '0') + 
    String(now.getDate()).padStart(2, '0') + '_' +
    String(now.getHours()).padStart(2, '0') + 
    String(now.getMinutes()).padStart(2, '0');
  
  link.setAttribute('download', `mongodb_${dataType}_${timestamp}.csv`);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

// Table filtering functionality
function filterTable() {
  const table = document.querySelector('#clusters-table');
  if (!table) return;

  const usernameCheckboxes = document.querySelectorAll('.username-filter:checked');
  const selectedUsernames = Array.from(usernameCheckboxes).map(cb => cb.value.toLowerCase());
  
  const rows = table.querySelectorAll('tbody tr');
  
  rows.forEach(row => {
    const cells = Array.from(row.querySelectorAll('td'));
    let showRow = true;
    
    // Username filter
    if (selectedUsernames.length > 0) {
      const usernameCell = cells[4]; // Username column
      const usernameText = usernameCell ? usernameCell.textContent.toLowerCase().trim() : '';
      showRow = showRow && selectedUsernames.some(filter => usernameText.includes(filter));
    }
    
    row.style.display = showRow ? '' : 'none';
  });
  
  // Update pagination after filtering
  tableRows = Array.from(rows).filter(row => row.style.display !== 'none');
  updatePagination();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
  initPagination();
  
  // Initialize table filters
  if (document.querySelector('#clusters-table')) {
    filterTable();
  }
  
  // Convert UTC timestamp to local timezone
  convertTimestampToLocal();
});

// Convert cache timestamp to local timezone with timezone display
function convertTimestampToLocal() {
  const timestampElement = document.getElementById('cache-timestamp');
  if (timestampElement && timestampElement.dataset.utc) {
    try {
      const utcTimestamp = timestampElement.dataset.utc;
      const date = new Date(utcTimestamp);
      
      // For main dashboard, show just date in YYYY-MM-DD format with timezone
      const localDateString = date.getFullYear() + '-' + 
        String(date.getMonth() + 1).padStart(2, '0') + '-' + 
        String(date.getDate()).padStart(2, '0');
      
      // Get timezone abbreviation
      const timezone = date.toLocaleDateString('en-US', {
        timeZoneName: 'short'
      }).split(', ')[1];
      
      timestampElement.textContent = `${localDateString} ${timezone}`;
    } catch (error) {
      console.warn('Error converting timestamp:', error);
    }
  }
}
</script>
{% endblock %}