{% extends "base_material.html" %}

{% block title %}Backup Storage Configurations{% endblock %}
{% block page_title %}Backup Storage Configurations{% endblock %}
{% block page_subtitle %}Monitor backup storage configurations across all MongoDB Ops Manager instances{% endblock %}

{% block page_actions %}
<form method="post" style="display: inline;">
  <input type="hidden" name="refresh" value="true">
  <button type="submit" class="btn btn-primary" data-loading="true" title="Refresh data from API">
    <i class="ti ti-refresh me-1"></i>
    Refresh Data
  </button>
</form>
{% endblock %}

{% block content %}
<div class="page-wrapper">
  <!-- Status Alert -->
  {% if status_message %}
  <div class="container-xl">
    <div class="alert alert-{{ 'danger' if status_type == 'error' else status_type }} alert-dismissible" role="alert">
      <div class="d-flex">
        <div>
          <i class="ti ti-{% if status_type == 'success' %}check{% elif status_type == 'warning' %}alert-triangle{% else %}info-circle{% endif %} me-2"></i>
        </div>
        <div>
          {{ status_message }}
        </div>
      </div>
      <a class="btn-close" data-bs-dismiss="alert" aria-label="close"></a>
    </div>
  </div>
  {% endif %}

<!-- Cache Info -->
{% if selected_regions or selected_environments %}
<div class="row mb-3">
  <div class="col-12">
    <div class="alert alert-info d-flex align-items-center">
      <i class="ti ti-clock me-2"></i>
      <div>
        <strong>Last Data Refresh:</strong> 
        {% if cache_timestamp %}
          <span id="cache-timestamp" data-utc="{{ cache_timestamp }}">{{ cache_timestamp[:19].replace('T', ' ') }} UTC</span>
        {% else %}
          No cached data available
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endif %}

  <div class="page-body">
    <div class="container-xl">
      <!-- Summary Statistics -->
      <div class="row mb-4">
        <div class="col-sm-6 col-lg-3">
          <div class="card card-sm">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-auto">
                  <span class="bg-blue text-white avatar">
                    <i class="ti ti-database"></i>
                  </span>
                </div>
                <div class="col">
                  <div class="font-weight-medium">Snapshot Blockstore</div>
                  <div class="text-muted">{{ snapshot_blockstore_data|length }} configurations</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-sm-6 col-lg-3">
          <div class="card card-sm">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-auto">
                  <span class="bg-green text-white avatar">
                    <i class="ti ti-cloud"></i>
                  </span>
                </div>
                <div class="col">
                  <div class="font-weight-medium">Snapshot S3</div>
                  <div class="text-muted">{{ snapshot_s3_data|length }} configurations</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-sm-6 col-lg-3">
          <div class="card card-sm">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-auto">
                  <span class="bg-orange text-white avatar">
                    <i class="ti ti-file-text"></i>
                  </span>
                </div>
                <div class="col">
                  <div class="font-weight-medium">Oplog Store</div>
                  <div class="text-muted">{{ oplog_store_data|length }} configurations</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-sm-6 col-lg-3">
          <div class="card card-sm">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-auto">
                  <span class="bg-purple text-white avatar">
                    <i class="ti ti-cloud-upload"></i>
                  </span>
                </div>
                <div class="col">
                  <div class="font-weight-medium">Oplog S3</div>
                  <div class="text-muted">{{ oplog_s3_data|length }} configurations</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tables and Filters Row -->
      <div class="row">
        <!-- Tables Section -->
        <div class="col-lg-9">
          
          <!-- Snapshot Blockstore Table -->
          <div class="card mb-4" id="snapshot-blockstore-section">
            <div class="card-header d-flex align-items-center justify-content-between">
              <h3 class="card-title">
                <i class="ti ti-database me-2 text-blue"></i>
                Snapshot MongoDB Blockstore
              </h3>
              <div class="card-actions d-flex align-items-center">
                {% if snapshot_blockstore_data|length > 0 %}
                <button type="button" class="btn btn-blue btn-sm me-2" onclick="exportTableToCSV('snapshot-blockstore-table', 'snapshot_blockstore')" title="Export to CSV">
                  <i class="ti ti-download"></i>
                  Export CSV
                </button>
                {% endif %}
                <span class="badge bg-blue fs-6">{{ snapshot_blockstore_data|length }} configs</span>
                <button type="button" class="btn btn-sm btn-ghost-secondary ms-2" onclick="toggleTable('snapshot-blockstore')">
                  <i class="ti ti-chevron-up" id="snapshot-blockstore-toggle"></i>
                </button>
              </div>
            </div>
            <div class="collapse show" id="snapshot-blockstore-collapse">
              {% if snapshot_blockstore_data|length > 0 %}
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-hover mb-0" id="snapshot-blockstore-table">
                    <thead>
                      <tr>
                        <th><i class="ti ti-server me-1"></i>Ops Manager</th>
                        <th><i class="ti ti-id me-1"></i>Configuration ID</th>
                        <th><i class="ti ti-link me-1"></i>URI</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in snapshot_blockstore_data %}
                      <tr>
                        <td><span class="text-muted">{{ item.get('Ops Manager', 'N/A') | truncate_url }}</span></td>
                        <td><code class="text-blue">{{ item.get('id', 'N/A') }}</code></td>
                        <td><span class="font-monospace text-info">{{ item.get('uri', 'N/A') }}</span></td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
              {% else %}
              <div class="card-body">
                <div class="empty">
                  <div class="empty-img"><i class="ti ti-database" style="font-size: 48px; color: #6c757d;"></i></div>
                  <p class="empty-title">No Snapshot Blockstore configurations found</p>
                  <p class="empty-subtitle text-muted">No MongoDB blockstore configurations for snapshots in selected environments.</p>
                </div>
              </div>
              {% endif %}
            </div>
          </div>

          <!-- Snapshot S3 Table -->
          <div class="card mb-4" id="snapshot-s3-section">
            <div class="card-header d-flex align-items-center justify-content-between">
              <h3 class="card-title">
                <i class="ti ti-cloud me-2 text-green"></i>
                Snapshot S3 Configuration
              </h3>
              <div class="card-actions d-flex align-items-center">
                {% if snapshot_s3_data|length > 0 %}
                <button type="button" class="btn btn-green btn-sm me-2" onclick="exportTableToCSV('snapshot-s3-table', 'snapshot_s3')" title="Export to CSV">
                  <i class="ti ti-download"></i>
                  Export CSV
                </button>
                {% endif %}
                <span class="badge bg-green fs-6">{{ snapshot_s3_data|length }} configs</span>
                <button type="button" class="btn btn-sm btn-ghost-secondary ms-2" onclick="toggleTable('snapshot-s3')">
                  <i class="ti ti-chevron-up" id="snapshot-s3-toggle"></i>
                </button>
              </div>
            </div>
            <div class="collapse show" id="snapshot-s3-collapse">
              {% if snapshot_s3_data|length > 0 %}
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-hover mb-0" id="snapshot-s3-table">
                    <thead>
                      <tr>
                        <th><i class="ti ti-server me-1"></i>Ops Manager</th>
                        <th><i class="ti ti-id me-1"></i>Configuration ID</th>
                        <th><i class="ti ti-link me-1"></i>URI</th>
                        <th><i class="ti ti-bucket me-1"></i>S3 Bucket</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in snapshot_s3_data %}
                      <tr>
                        <td><span class="text-muted">{{ item.get('Ops Manager', 'N/A') | truncate_url }}</span></td>
                        <td><code class="text-green">{{ item.get('id', 'N/A') }}</code></td>
                        <td><span class="font-monospace text-info">{{ item.get('uri', 'N/A') }}</span></td>
                        <td>
                          {% if item.get('bucket_name') and item.get('bucket_name') != 'N/A' %}
                          <span class="badge bg-green-lt">{{ item.get('bucket_name') }}</span>
                          {% else %}
                          <span class="text-muted">-</span>
                          {% endif %}
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
              {% else %}
              <div class="card-body">
                <div class="empty">
                  <div class="empty-img"><i class="ti ti-cloud" style="font-size: 48px; color: #6c757d;"></i></div>
                  <p class="empty-title">No Snapshot S3 configurations found</p>
                  <p class="empty-subtitle text-muted">No S3 configurations for snapshots in selected environments.</p>
                </div>
              </div>
              {% endif %}
            </div>
          </div>

          <!-- Oplog Store Table -->
          <div class="card mb-4" id="oplog-store-section">
            <div class="card-header d-flex align-items-center justify-content-between">
              <h3 class="card-title">
                <i class="ti ti-file-text me-2 text-orange"></i>
                Oplog MongoDB Storage
              </h3>
              <div class="card-actions d-flex align-items-center">
                {% if oplog_store_data|length > 0 %}
                <button type="button" class="btn btn-orange btn-sm me-2" onclick="exportTableToCSV('oplog-store-table', 'oplog_store')" title="Export to CSV">
                  <i class="ti ti-download"></i>
                  Export CSV
                </button>
                {% endif %}
                <span class="badge bg-orange fs-6">{{ oplog_store_data|length }} configs</span>
                <button type="button" class="btn btn-sm btn-ghost-secondary ms-2" onclick="toggleTable('oplog-store')">
                  <i class="ti ti-chevron-up" id="oplog-store-toggle"></i>
                </button>
              </div>
            </div>
            <div class="collapse show" id="oplog-store-collapse">
              {% if oplog_store_data|length > 0 %}
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-hover mb-0" id="oplog-store-table">
                    <thead>
                      <tr>
                        <th><i class="ti ti-server me-1"></i>Ops Manager</th>
                        <th><i class="ti ti-id me-1"></i>Configuration ID</th>
                        <th><i class="ti ti-link me-1"></i>URI</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in oplog_store_data %}
                      <tr>
                        <td><span class="text-muted">{{ item.get('Ops Manager', 'N/A') | truncate_url }}</span></td>
                        <td><code class="text-orange">{{ item.get('id', 'N/A') }}</code></td>
                        <td><span class="font-monospace text-info">{{ item.get('uri', 'N/A') }}</span></td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
              {% else %}
              <div class="card-body">
                <div class="empty">
                  <div class="empty-img"><i class="ti ti-file-text" style="font-size: 48px; color: #6c757d;"></i></div>
                  <p class="empty-title">No Oplog Store configurations found</p>
                  <p class="empty-subtitle text-muted">No MongoDB oplog storage configurations in selected environments.</p>
                </div>
              </div>
              {% endif %}
            </div>
          </div>

          <!-- Oplog S3 Table -->
          <div class="card mb-4" id="oplog-s3-section">
            <div class="card-header d-flex align-items-center justify-content-between">
              <h3 class="card-title">
                <i class="ti ti-cloud-upload me-2 text-purple"></i>
                Oplog S3 Configuration
              </h3>
              <div class="card-actions d-flex align-items-center">
                {% if oplog_s3_data|length > 0 %}
                <button type="button" class="btn btn-purple btn-sm me-2" onclick="exportTableToCSV('oplog-s3-table', 'oplog_s3')" title="Export to CSV">
                  <i class="ti ti-download"></i>
                  Export CSV
                </button>
                {% endif %}
                <span class="badge bg-purple fs-6">{{ oplog_s3_data|length }} configs</span>
                <button type="button" class="btn btn-sm btn-ghost-secondary ms-2" onclick="toggleTable('oplog-s3')">
                  <i class="ti ti-chevron-up" id="oplog-s3-toggle"></i>
                </button>
              </div>
            </div>
            <div class="collapse show" id="oplog-s3-collapse">
              {% if oplog_s3_data|length > 0 %}
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-hover mb-0" id="oplog-s3-table">
                    <thead>
                      <tr>
                        <th><i class="ti ti-server me-1"></i>Ops Manager</th>
                        <th><i class="ti ti-id me-1"></i>Configuration ID</th>
                        <th><i class="ti ti-link me-1"></i>URI</th>
                        <th><i class="ti ti-bucket me-1"></i>S3 Bucket</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in oplog_s3_data %}
                      <tr>
                        <td><span class="text-muted">{{ item.get('Ops Manager', 'N/A') | truncate_url }}</span></td>
                        <td><code class="text-purple">{{ item.get('id', 'N/A') }}</code></td>
                        <td><span class="font-monospace text-info">{{ item.get('uri', 'N/A') }}</span></td>
                        <td>
                          {% if item.get('bucket_name') and item.get('bucket_name') != 'N/A' %}
                          <span class="badge bg-purple-lt">{{ item.get('bucket_name') }}</span>
                          {% else %}
                          <span class="text-muted">-</span>
                          {% endif %}
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
              {% else %}
              <div class="card-body">
                <div class="empty">
                  <div class="empty-img"><i class="ti ti-cloud-upload" style="font-size: 48px; color: #6c757d;"></i></div>
                  <p class="empty-title">No Oplog S3 configurations found</p>
                  <p class="empty-subtitle text-muted">No S3 oplog configurations in selected environments.</p>
                </div>
              </div>
              {% endif %}
            </div>
          </div>

        </div>
        
        <!-- Sidebar Filters -->
        <div class="col-lg-3">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">
                <i class="ti ti-filter me-2"></i>
                Filters
              </h3>
            </div>
            <div class="card-body">
              <form method="POST" action="/backup-storage" id="filterForm">
                <!-- Data Source Selection -->
                <div class="mb-4">
                  <h4 class="subheader mb-3">Data Source</h4>
                  
                  <div class="row">
                    <!-- Regions -->
                    <div class="col-12 mb-3">
                      <label class="form-label fw-semibold">
                        <i class="ti ti-world-pin me-1"></i>
                        Regions
                      </label>
                      {% for region in unique_region %}
                      <div class="form-check mb-1">
                        <input class="form-check-input" type="checkbox" 
                              id="regionCheckbox{{ loop.index }}" 
                              name="regions"
                              value="{{ region }}" 
                              {% if region in selected_regions %}checked{% endif %}
                              onchange="this.form.submit()">
                        <label class="form-check-label" for="regionCheckbox{{ loop.index }}">
                          {{ region.title() }}
                        </label>
                      </div>
                      {% endfor %}
                    </div>
                    
                    <!-- Environments -->
                    <div class="col-12">
                      <label class="form-label fw-semibold">
                        <i class="ti ti-settings me-1"></i>
                        Environments
                      </label>
                      {% for env in unique_env %}
                      <div class="form-check mb-1">
                        <input class="form-check-input" type="checkbox" 
                              id="envCheckbox{{ loop.index }}" 
                              name="environments"
                              value="{{ env }}" 
                              {% if env in selected_environments %}checked{% endif %}
                              onchange="this.form.submit()">
                        <label class="form-check-label" for="envCheckbox{{ loop.index }}">
                          {{ env.title() }}
                        </label>
                      </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
                
                
              </form>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Cache Information -->
      {% if cache_timestamp %}
      <div class="row mt-3">
        <div class="col-12">
          <div class="card">
            <div class="card-body py-2">
              <div class="d-flex align-items-center text-muted">
                <i class="ti ti-clock me-2"></i>
                <small>Last refreshed: <span id="cache-timestamp" data-timestamp="{{ cache_timestamp }}">{{ cache_timestamp }}</span></small>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
      
    </div>
  </div>
</div>

<script>
// Table collapse/expand functionality
function toggleTable(tableType) {
  const collapse = document.getElementById(tableType + '-collapse');
  const toggle = document.getElementById(tableType + '-toggle');
  
  if (collapse.classList.contains('show')) {
    collapse.classList.remove('show');
    toggle.classList.remove('ti-chevron-up');
    toggle.classList.add('ti-chevron-down');
  } else {
    collapse.classList.add('show');
    toggle.classList.remove('ti-chevron-down');
    toggle.classList.add('ti-chevron-up');
  }
}

// Export individual table to CSV
function exportTableToCSV(tableId, storageType) {
  const table = document.getElementById(tableId);
  const rows = table.querySelectorAll('tr');
  const csvContent = [];
  
  // Header row
  const headerCells = rows[0].querySelectorAll('th');
  const headerRow = Array.from(headerCells).map(cell => `"${cell.textContent.trim().replace(/\s+/g, ' ')}"`);
  csvContent.push(headerRow.join(','));
  
  // Data rows
  for (let i = 1; i < rows.length; i++) {
    const cells = rows[i].querySelectorAll('td');
    const rowData = [];
    
    for (let j = 0; j < cells.length; j++) {
      let cellText = cells[j].textContent.trim();
      cellText = cellText.replace(/\s+/g, ' ');
      rowData.push(`"${cellText}"`);
    }
    csvContent.push(rowData.join(','));
  }
  
  // Create and download CSV
  const csvString = csvContent.join('\n');
  const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', `${storageType}_configurations_${new Date().toISOString().split('T')[0]}.csv`);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// Convert timestamp to local time
function convertTimestampToLocal() {
  const timestampElement = document.getElementById('cache-timestamp');
  if (timestampElement) {
    const timestamp = timestampElement.getAttribute('data-timestamp');
    if (timestamp) {
      const date = new Date(timestamp);
      timestampElement.textContent = date.toLocaleString();
    }
  }
}


// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  convertTimestampToLocal();
});
</script>
{% endblock %}