<!doctype html>
<html lang="en">
<!--begin::Head-->
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>MongoDB Monitoring Users | Ops Manager Dashboard</title>
  <!--begin::Accessibility Meta Tags-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="color-scheme" content="light dark" />
  <meta name="theme-color" content="#007bff" media="(prefers-color-scheme: light)" />
  <meta name="theme-color" content="#1a1a1a" media="(prefers-color-scheme: dark)" />
  <!--end::Accessibility Meta Tags-->
  <!--begin::Primary Meta Tags-->
  <meta name="title" content="MongoDB Monitoring Users | Ops Manager Dashboard" />
  <meta name="author" content="MongoDB Ops Manager Team" />
  <meta
    name="description"
    content="Monitor MongoDB cluster monitoring users across multiple regions and environments. Real-time monitoring user tracking with filtering and refresh capabilities."
  />
  <meta
    name="keywords"
    content="mongodb, ops manager, monitoring users, cluster monitoring, database monitoring, mongodb dashboard"
  />
  <!--end::Primary Meta Tags-->
  <!--begin::Accessibility Features-->
  <meta name="supported-color-schemes" content="light dark" />
  <link rel="preload" href="../static/css/adminlte.css" as="style" />
  <!--end::Accessibility Features-->
  <!--begin::Fonts-->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css"
    integrity="sha256-tXJfXfp6Ewt1ilPzLDtQnJV4hclT9XuaZUKyUvmyr+Q="
    crossorigin="anonymous"
    media="print"
    onload="this.media='all'"
  />
  <!--end::Fonts-->
  <!--begin::Third Party Plugin(OverlayScrollbars)-->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/styles/overlayscrollbars.min.css"
    crossorigin="anonymous"
  />
  <!--end::Third Party Plugin(OverlayScrollbars)-->
  <!--begin::Third Party Plugin(Bootstrap Icons)-->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    crossorigin="anonymous"
  />
  <!--end::Third Party Plugin(Bootstrap Icons)-->
  <!--begin::Required Plugin(AdminLTE)-->
  <link rel="stylesheet" href="../static/css/adminlte.css" />
  <!--end::Required Plugin(AdminLTE)-->
  <!--begin::Custom Styles-->
  <style>
    /* Completely remove all blue navigation highlights and active states */
    .nav-link, .nav-link:hover, .nav-link:focus, .nav-link.active,
    .nav-item.menu-open > .nav-link, .navbar-nav .nav-link {
      background-color: transparent !important;
      color: #adb5bd !important;
      border: none !important;
      box-shadow: none !important;
    }
    
    /* Loading button styles */
    .btn-loading {
      position: relative;
      color: transparent !important;
    }
    
    .btn-loading:disabled {
      cursor: wait !important;
    }
    
    /* Improve spinner visibility */
    .spinner-border-sm {
      width: 1rem;
      height: 1rem;
      border-width: 0.15em;
    }
    .nav-link:hover {
      background-color: rgba(255,255,255,0.1) !important;
      color: #ffffff !important;
    }
    /* Remove any potential blue from navbar and brand elements */
    .navbar-nav .nav-item .nav-link {
      background: none !important;
    }
    .brand-link, .brand-link:hover, .brand-link:focus {
      background-color: transparent !important;
      border: none !important;
    }
    /* Ensure sidebar links don't have blue highlighting */
    .sidebar-menu .nav-link {
      background-color: transparent !important;
    }
    .sidebar-menu .nav-link:hover {
      background-color: rgba(255,255,255,0.1) !important;
    }
    /* Table sorting styles */
    .sortable {
      cursor: pointer;
      user-select: none;
    }
    .sortable:hover {
      background-color: #f8f9fa;
    }
    .sorted-asc i::before {
      content: "\f148" !important; /* bi-arrow-up */
    }
    .sorted-desc i::before {
      content: "\f149" !important; /* bi-arrow-down */
    }
  </style>
  <!--end::Custom Styles-->
</head>
<!--end::Head-->
<!--begin::Body-->
<body class="layout-fixed sidebar-expand-lg sidebar-open bg-body-tertiary">
  <!--begin::App Wrapper-->
  
  <div class="app-wrapper">
    <!--begin::Header-->
    <nav class="app-header navbar navbar-expand bg-body">
      <!--begin::Container-->
      <div class="container-fluid d-flex align-items-center">
        <!-- Navbar toggle -->
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link" data-lte-toggle="sidebar" href="#" role="button" title="Toggle Sidebar">
              <i class="bi bi-list"></i>
            </a>
          </li>
          <li class="nav-item d-none d-md-block">
            <a href="/" class="nav-link">
              <i class="bi bi-house"></i> Dashboard
            </a>
          </li>
          <li class="nav-item d-none d-md-block">
            <a href="/second" class="nav-link">
              <i class="bi bi-shield-check"></i> Backup Monitoring
            </a>
          </li>
        </ul>
      </div>
    </nav>
    <!--end::Header-->
    <!--begin::Sidebar-->
    <aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="dark">
      <div class="sidebar-brand">
        <a href="/" class="brand-link">
          <img src="../static/assets/img/AdminLTELogo.png" alt="MongoDB Ops Manager" class="brand-image opacity-75 shadow" />
          <span class="brand-text fw-light">Ops Manager</span>
        </a>
      </div>
      <div class="sidebar-wrapper">
        <nav class="mt-2">
          <ul class="nav sidebar-menu flex-column" data-lte-toggle="treeview" role="navigation" aria-label="Main navigation" data-accordion="false">
            <li class="nav-item">
              <a href="/" class="nav-link">
                <i class="nav-icon bi bi-speedometer2"></i>
                <p>Dashboard</p>
              </a>
            </li>
            <li class="nav-item">
              <a href="/second" class="nav-link">
                <i class="nav-icon bi bi-shield-check"></i>
                <p>Backup Monitoring</p>
              </a>
            </li>
            <li class="nav-item">
              <a href="/monitoring" class="nav-link">
                <i class="nav-icon bi bi-person-check"></i>
                <p>Monitoring Users</p>
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </aside>
    <!--end::Sidebar-->
    <!--begin::Main Content-->
    <main class="app-main">
      <!-- Content Header -->
      <div class="app-content-header">
        <div class="container-fluid">
          <div class="row">
            <div class="col-sm-12">
              <h3 class="mb-0">MongoDB Monitoring Users</h3>
              <p class="text-muted mb-0">Monitor cluster monitoring users across regions and environments</p>
            </div>
          </div>
        </div>
      </div>
      <!-- Main Content -->
      <div class="app-content">
        <div class="container-fluid">
          <!-- Status Messages -->
          {% if status_message %}
          <div class="row">
            <div class="col-12">
              <div class="alert alert-{{ 'danger' if status_type == 'error' else ('warning' if status_type == 'warning' else ('info' if status_type == 'info' else 'success')) }} alert-dismissible fade show" role="alert">
                <i class="bi bi-{% if status_type == 'success' %}check-circle{% elif status_type == 'warning' %}exclamation-triangle{% elif status_type == 'error' %}x-circle{% else %}info-circle{% endif %}"></i>
                {{ status_message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- Selected Ops Managers Display -->
          <div id="selected-ops-managers" class="row mt-4" style="display: none;">
            <div class="col-12">
              <div class="card">
                <div class="card-body">
                  <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-server me-2 text-primary fs-5"></i>
                    <h5 class="mb-0 fw-bold">Selected Ops Managers</h5>
                    <span id="ops-count" class="badge bg-primary ms-2">0</span>
                  </div>
                  <div class="row" id="ops-manager-cards">
                    <!-- Dynamic content will be inserted here -->
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-9">
              <!-- Table Card -->
              <div class="card mb-4">
                <div class="card-header">
                  <h3 class="card-title">Monitoring Users</h3>
                  <div class="card-tools">
                    <span class="badge {% if data and data|length > 0 %}bg-info{% else %}bg-secondary{% endif %}" id="totalRowCount">
                      {% if data %}{{ data|length }}{% else %}0{% endif %} hosts
                    </span>
                  </div>
                </div>
                <div class="card-body">
                  <!-- Data Table -->
                   <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                      <label for="rowsPerPage" class="form-label me-2 mb-0">Rows per page:</label>
                      <select id="rowsPerPage" class="form-select d-inline-block w-auto" onchange="updatePagination()">
                        <option value="100" selected>100</option>
                        <option value="200">200</option>
                        <option value="300">300</option>
                        <option value="All">All</option>
                      </select>
                    </div>
                    <nav>
                      <ul class="pagination mb-0" id="pagination"></ul>
                    </nav>
                  </div>
                  {% if data %}
                  <table class="table table-bordered table-hover" id="clusters-table">
                    <thead>
                      <tr>
                        {% set column_order = ['Ops Manager', 'Project', 'Replica Set Name', 'Hostname:Port', 'Username', 'Last Ping'] %}
                        {% for key in column_order %}
                          {% if key in data[0] and key not in ['Region', 'Environment'] %}
                          <th class="sortable" onclick="sortTable({{ loop.index0 }})">
                            {{ key }}
                            <i class="bi bi-arrow-up-down ms-1" style="font-size: 0.8rem;"></i>
                          </th>
                          {% endif %}
                        {% endfor %}
                      </tr>
                    </thead>
                    <tbody>
                      {% for row in data %}
                      <tr class="align-middle">
                        {% for key in column_order %}
                          {% if key in row and key not in ['Region', 'Environment'] %}
                          <td {% if key == 'Ops Manager' %}style="font-size: 0.75rem;"{% elif key == 'Hostname:Port' %}style="font-size: 0.8rem;"{% endif %}>{{ row[key] }}</td>
                          {% endif %}
                        {% endfor %}
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                  {% else %}
                  <div class="text-center py-5">
                    <i class="bi bi-database text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-3 mb-0">Select region and environment to view monitoring users</p>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card card-outline mb-4">
                  <!--begin::Header-->
                  <div class="card-header"><div class="card-title">Filters</div></div>
                  <!--end::Header-->
                  <!--begin::Form-->
                  <form method="POST" action="/monitoring">
                    <div class="card-body">
                      <!-- Data Source Selection -->
                      <fieldset class="mb-4">
                        <legend class="fs-6 fw-bold mb-3">Data Source</legend>
                        
                        <div class="row">
                          <!-- Region Column -->
                          <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Region</label>
                            {% for region in unique_region %}
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" 
                                    id="regionCheckbox{{ loop.index }}" 
                                    name="regions"
                                    value="{{ region }}" 
                                    {% if region in selected_regions %}checked{% endif %}
                                    onchange="this.form.submit()">
                              <label class="form-check-label" for="regionCheckbox{{ loop.index }}">
                                {{ region }}
                              </label>
                            </div>
                            {% endfor %}
                          </div>
                          
                          <!-- Environment Column -->
                          <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Environment</label>
                            {% for env in unique_env %}
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" 
                                    id="envCheckbox{{ loop.index }}" 
                                    name="environments"
                                    value="{{ env }}" 
                                    {% if env in selected_environments %}checked{% endif %}
                                    onchange="this.form.submit()">
                              <label class="form-check-label" for="envCheckbox{{ loop.index }}">
                                {{ env }}
                              </label>
                            </div>
                            {% endfor %}
                          </div>
                        </div>
                        
                        <!-- Refresh Button -->
                        {% if selected_regions or selected_environments %}
                        <div class="d-grid mt-3">
                          <button type="submit" name="refresh_data" value="1" class="btn btn-primary">
                            <i class="bi bi-arrow-clockwise"></i> Refresh Data
                          </button>
                        </div>
                        {% endif %}
                      </fieldset>

                      <!-- Table Filters -->
                      {% if unique_usernames %}
                      <fieldset class="mb-3">
                        <legend class="fs-6 fw-bold mb-3">Table Filters</legend>
                        
                        <div class="row">
                          <!-- Username Column -->
                          <div class="col-md-12 mb-3">
                            <label class="form-label fw-semibold">Username</label>
                            {% for username in unique_usernames %}
                            <div class="form-check">
                              <input class="form-check-input username-filter" type="checkbox" 
                                    id="usernameCheckbox{{ loop.index }}" 
                                    value="{{ username }}" 
                                    onchange="filterTable()">
                              <label class="form-check-label" for="usernameCheckbox{{ loop.index }}">
                                {{ username }}
                              </label>
                            </div>
                            {% endfor %}
                          </div>
                        </div>
                      </fieldset>
                      {% endif %}
                    </div>
                  </form>

                  <!--end::Form-->
                </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <!--end::Main Content-->
    <!--begin::Footer-->
    <footer class="app-footer">
      <div class="float-end d-none d-sm-inline">MongoDB Ops Manager Dashboard</div>
      <strong>&copy; 2025 MongoDB Operations Team.</strong> All rights reserved.
    </footer>
  </div>
  <!--end::App Wrapper-->
  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/browser/overlayscrollbars.browser.es6.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>
  <script src="../static/js/adminlte.js"></script>
  <script>
    let currentPage = 1;
    let rowsPerPage = parseInt(document.getElementById('rowsPerPage').value);
    let tableRows = [];

    function initPagination() {
      const table = document.querySelector('#clusters-table');
      if (table) {
        tableRows = Array.from(table.querySelectorAll('tbody tr'));
        updatePagination();
      }
    }

    function updatePagination() {
      rowsPerPage = document.getElementById('rowsPerPage').value;
      if (rowsPerPage === 'All') {
        rowsPerPage = tableRows.length;
      } else {
        rowsPerPage = parseInt(rowsPerPage);
      }
      currentPage = 1;
      showPage(currentPage);
      createPaginationControls();
    }

    function showPage(page) {
      const start = (page - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      tableRows.forEach((row, index) => {
        row.style.display = (index >= start && index < end) ? '' : 'none';
      });
    }

    function createPaginationControls() {
      const totalPages = Math.ceil(tableRows.length / rowsPerPage);
      const paginationUl = document.getElementById('pagination');
      paginationUl.innerHTML = '';

      // Previous button
      const prevLi = document.createElement('li');
      prevLi.className = 'page-item' + (currentPage === 1 ? ' disabled' : '');
      prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">Previous</a>`;
      paginationUl.appendChild(prevLi);

      // Page numbers
      for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        li.className = 'page-item' + (i === currentPage ? ' active' : '');
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>`;
        paginationUl.appendChild(li);
      }

      // Next button
      const nextLi = document.createElement('li');
      nextLi.className = 'page-item' + (currentPage === totalPages ? ' disabled' : '');
      nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">Next</a>`;
      paginationUl.appendChild(nextLi);
    }

    function changePage(page) {
      const totalPages = Math.ceil(tableRows.length / rowsPerPage);
      if (page < 1 || page > totalPages) return;
      currentPage = page;
      showPage(currentPage);
      createPaginationControls();
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      initPagination();
      // Initialize count badges on page load
      if (document.querySelector('#clusters-table')) {
        filterTable();
      }
      
      // Add event listeners for region/environment checkboxes
      const regionCheckboxes = document.querySelectorAll('input[name="regions"]');
      const environmentCheckboxes = document.querySelectorAll('input[name="environments"]');
      
      regionCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedOpsManagers);
      });
      
      environmentCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedOpsManagers);
      });
      
      // Initialize ops managers display
      updateSelectedOpsManagers();
    });

    // Show loading spinner when refresh button is clicked
    function showLoadingSpinner(button) {
      console.log('DEBUG: showLoadingSpinner called');
      
      // Immediately show spinner and disable button
      const originalContent = button.innerHTML;
      const originalClasses = button.className;
      
      // Store original state
      button.setAttribute('data-original-content', originalContent);
      button.setAttribute('data-original-classes', originalClasses);
      
      // Show spinner immediately
      button.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Refreshing...';
      button.disabled = true;
      button.className = button.className.replace('btn-primary', 'btn-secondary');
      
      // Allow form submission to proceed
      return true;
    }
    
    // Function to restore button state (in case of errors)
    function restoreButton(button) {
      const originalContent = button.getAttribute('data-original-content');
      const originalClasses = button.getAttribute('data-original-classes');
      
      if (originalContent) {
        button.innerHTML = originalContent;
        button.disabled = false;
        if (originalClasses) {
          button.className = originalClasses;
        }
      }
    }

    // Update selected ops managers display
    function updateSelectedOpsManagers() {
      const regionCheckboxes = document.querySelectorAll('input[name="regions"]:checked');
      const environmentCheckboxes = document.querySelectorAll('input[name="environments"]:checked');
      
      const selectedRegions = Array.from(regionCheckboxes).map(cb => cb.value);
      const selectedEnvironments = Array.from(environmentCheckboxes).map(cb => cb.value);
      
      const opsManagersContainer = document.getElementById('selected-ops-managers');
      const opsCardsContainer = document.getElementById('ops-manager-cards');
      const opsCountBadge = document.getElementById('ops-count');
      
      // Hide if no selections
      if (selectedRegions.length === 0 && selectedEnvironments.length === 0) {
        opsManagersContainer.style.display = 'none';
        return;
      }
      
      // Get all ops managers from template data
      const allOpsManagers = {{ list_opsmanager.ops_manager | tojson | safe }};
      
      // Safety check
      if (!allOpsManagers || !Array.isArray(allOpsManagers)) {
        console.error('allOpsManagers is not a valid array:', allOpsManagers);
        opsManagersContainer.style.display = 'none';
        return;
      }
      
      // Filter matching ops managers
      const matchingOpsManagers = allOpsManagers.filter(om => {
        const regionMatch = selectedRegions.length === 0 || selectedRegions.includes(om.region);
        const envMatch = selectedEnvironments.length === 0 || selectedEnvironments.includes(om.environment);
        return regionMatch && envMatch;
      });
      
      // Group ops managers by region and environment
      const grouped = {};
      matchingOpsManagers.forEach(om => {
        const key = `${om.region}-${om.environment}`;
        if (!grouped[key]) {
          grouped[key] = {
            region: om.region,
            environment: om.environment,
            opsManagers: []
          };
        }
        grouped[key].opsManagers.push(om);
      });
      
      // Update the display with grouped cards
      opsCardsContainer.innerHTML = '';
      Object.values(grouped).forEach(group => {
        const col = document.createElement('div');
        col.className = 'col-md-6 col-xl-4 mb-3';
        
        const urlsList = group.opsManagers.map(om => 
          `<div class="mb-2"><code class="small text-break d-block">${om.url}</code></div>`
        ).join('');
        
        col.innerHTML = `
          <div class="card border-left-primary h-100">
            <div class="card-body p-3">
              <div class="d-flex align-items-center mb-3">
                <span class="badge bg-secondary me-2">${group.region}</span>
                <span class="badge bg-info me-2">${group.environment}</span>
                <span class="badge bg-light text-dark">${group.opsManagers.length}</span>
              </div>
              <div class="small text-muted mb-2">Ops Manager URLs:</div>
              <div>${urlsList}</div>
            </div>
          </div>
        `;
        opsCardsContainer.appendChild(col);
      });
      
      // Update count and show container
      opsCountBadge.textContent = matchingOpsManagers.length;
      opsManagersContainer.style.display = matchingOpsManagers.length > 0 ? 'block' : 'none';
    }
    
    // Filter table based on username checkboxes
    function filterTable() {
      const table = document.querySelector('#clusters-table');
      if (!table) return;

      const usernameCheckboxes = document.querySelectorAll('.username-filter:checked');
      const selectedUsernames = Array.from(usernameCheckboxes).map(cb => cb.value.toLowerCase());
      
      const rows = table.querySelectorAll('tbody tr');
      const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
      
      const usernameIndex = headers.indexOf('Username');
      
      let visibleRowCount = 0;
      
      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        let showRow = true;
        
        // Get values (handle null/empty as NONE)
        let username = cells[usernameIndex]?.textContent.trim() || '';
        if (!username || username === 'null' || username === 'None') {
          username = 'none';
        } else {
          username = username.toLowerCase();
        }
        
        // Filter by username
        if (selectedUsernames.length > 0) {
          showRow = showRow && selectedUsernames.includes(username);
        }
        
        row.style.display = showRow ? '' : 'none';
        
        if (showRow) {
          visibleRowCount++;
        }
      });
      
      // Update total row count
      updateTotalRowCount(visibleRowCount);
      
      // Update pagination after filtering
      updatePaginationAfterFilter();
    }

    function updateTotalRowCount(count) {
      const countBadge = document.getElementById('totalRowCount');
      if (countBadge) {
        countBadge.textContent = `${count} hosts`;
        countBadge.className = count > 0 ? 'badge bg-info' : 'badge bg-secondary';
      }
    }

    function updatePaginationAfterFilter() {
      const table = document.querySelector('#clusters-table');
      if (table) {
        tableRows = Array.from(table.querySelectorAll('tbody tr')).filter(row => row.style.display !== 'none');
        currentPage = 1;
        showPage(currentPage);
        createPaginationControls();
      }
    }

    // Table sorting functionality
    let sortDirection = {};
    
    function sortTable(columnIndex) {
      const table = document.querySelector('#clusters-table');
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const headers = table.querySelectorAll('th');
      
      // Determine sort direction
      const currentDirection = sortDirection[columnIndex] || 'asc';
      const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
      sortDirection[columnIndex] = newDirection;
      
      // Clear previous sorting indicators
      headers.forEach(header => {
        header.classList.remove('sorted-asc', 'sorted-desc');
      });
      
      // Add sorting indicator to current column
      headers[columnIndex].classList.add(`sorted-${newDirection}`);
      
      // Sort rows
      rows.sort((a, b) => {
        const aValue = a.cells[columnIndex].textContent.trim();
        const bValue = b.cells[columnIndex].textContent.trim();
        
        // Try to parse as numbers first
        const aNum = parseFloat(aValue.replace(/[^0-9.-]/g, ''));
        const bNum = parseFloat(bValue.replace(/[^0-9.-]/g, ''));
        
        let comparison = 0;
        if (!isNaN(aNum) && !isNaN(bNum)) {
          comparison = aNum - bNum;
        } else {
          comparison = aValue.localeCompare(bValue, undefined, { numeric: true, sensitivity: 'base' });
        }
        
        return newDirection === 'asc' ? comparison : -comparison;
      });
      
      // Reattach sorted rows
      rows.forEach(row => tbody.appendChild(row));
      
      // Update tableRows array for pagination
      tableRows = rows;
      currentPage = 1;
      showPage(currentPage);
      createPaginationControls();
    }
    </script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const sidebarWrapper = document.querySelector('.sidebar-wrapper');
      if (sidebarWrapper && OverlayScrollbars) {
        OverlayScrollbars(sidebarWrapper, {
          scrollbars: {
            theme: 'os-theme-light',
            autoHide: 'leave',
            clickScroll: true,
          },
        });
      }
    });
  </script>
</body>
</html>